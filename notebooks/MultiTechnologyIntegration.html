<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Integration of Multiple Technologies &#8212; spatialproteomics</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css?v=a123c646" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script src="../_static/documentation_options.js?v=99d6104a"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js?v=dbd2e957"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FAQ" href="FAQ.html" />
    <link rel="prev" title="Interactive Removal of Artifacts" href="ArtifactRemoval.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">spatialproteomics</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Tutorials:
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="Installation.html">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ExampleWorkflow.html">
   Example Workflow with spatialproteomics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ExampleWorkflowSpatialdata.html">
   Example Workflow with spatialproteomics and spatialdata
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Plotting.html">
   Plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Segmentation.html">
   Segmentation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ImageProcessing.html">
   Image Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="CellTypePrediction.html">
   Cell Type Prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Neighborhoods.html">
   Neighborhood Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Interoperability.html">
   Interoperability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="DownstreamAnalysis.html">
   Downstream Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Interactivity.html">
   Interactivity with napari
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Customizability.html">
   Customizability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Slicing.html">
   Subselecting Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ArtifactRemoval.html">
   Interactive Removal of Artifacts
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Integration of Multiple Technologies
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="#CODEX">
   CODEX
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="FAQ.html">
   FAQ
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  API:
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../preprocessing.html">
   The preprocessing (
   <code class="code docutils literal notranslate">
    <span class="pre">
     pp
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../label.html">
   The label (
   <code class="code docutils literal notranslate">
    <span class="pre">
     la
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../neighborhood.html">
   The neighborhood (
   <code class="code docutils literal notranslate">
    <span class="pre">
     nh
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../plot.html">
   The plot (
   <code class="code docutils literal notranslate">
    <span class="pre">
     pl
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tool.html">
   The tool (
   <code class="code docutils literal notranslate">
    <span class="pre">
     tl
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../image_container.html">
   The image container
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/MultiTechnologyIntegration.ipynb.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Integration of Multiple Technologies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Data-Origin">
     Data Origin
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Data-Preparation">
     Data Preparation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#Imaging-Mass-Cytometry-(IMC)">
       Imaging Mass Cytometry (IMC)
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#MACSima-imaging-cyclic-staining-(MICS)">
       MACSima imaging cyclic staining (MICS)
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#CODEX">
   CODEX
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#Comparing-cell-type-abundances">
     Comparing cell type abundances
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Integration-of-Multiple-Technologies">
<h1>Integration of Multiple Technologies<a class="headerlink" href="#Integration-of-Multiple-Technologies" title="Link to this heading">¶</a></h1>
<p>There are different technologies to obtain multi-channel images: CODEX, Imaging Mass Cytometry (IMC), MACSima imaging cyclic staining (MICS), MIBI, etc. This notebook explores how you can use <code class="docutils literal notranslate"><span class="pre">spatialproteomics</span></code> to jointly analyse multiple modalities.</p>
<section id="Data-Origin">
<h2>Data Origin<a class="headerlink" href="#Data-Origin" title="Link to this heading">¶</a></h2>
<p>The IMC data was downloaded from <a class="reference external" href="https://figshare.com/articles/dataset/Raw_images_for_DLBCL_samples/20010146?file=35633237">here</a>. It contains IMC images of DLBCL TMAs.</p>
<p>MICS data was downloaded from <a class="reference external" href="https://zenodo.org/records/10057717">here</a>. It contains a tonsil sample.</p>
<p>A link to the CODEX data can be found in the <code class="docutils literal notranslate"><span class="pre">spatialproteomics</span></code> manuscript.</p>
</section>
<section id="Data-Preparation">
<h2>Data Preparation<a class="headerlink" href="#Data-Preparation" title="Link to this heading">¶</a></h2>
<p>For all three data modalities, we follow the same workflow of segmentation, protein quantification, and cell type prediction. Our downstream analysis is then carried out on the cell type level. This means that our data does not even need to have the same markers, as long as we can identify the same cell types with them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">spatialproteomics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>


<span class="n">celltype_colors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;B cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#5799d1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;T cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#ebc850&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Myeloid cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#de6866&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Dendritic cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#4cbcbd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Macrophage&quot;</span><span class="p">:</span> <span class="s2">&quot;#bb7cb4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Stromal cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#62b346&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Endothelial cell&quot;</span><span class="p">:</span> <span class="s2">&quot;#bf997d&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<section id="Imaging-Mass-Cytometry-(IMC)">
<h3>Imaging Mass Cytometry (IMC)<a class="headerlink" href="#Imaging-Mass-Cytometry-(IMC)" title="Link to this heading">¶</a></h3>
<p>For the IMC data, we have a diffuse large B cell lymphoma (DLBCL) sample. The data is comprised of individual tiff files (one per marker), as well as a tiff file containing a segmentation that was performed with <code class="docutils literal notranslate"><span class="pre">ilastik</span></code>. The first step is to read this data into <code class="docutils literal notranslate"><span class="pre">spatialproteomics</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_imc_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="c1"># === DATA READING ===</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;*.tiff&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;ilastik&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">marker_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tiff&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker_name</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

    <span class="n">segmentation</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;DLBCL TMA #5_1_3964_1_a0_ilastik_s2_Probabilities_mask.tiff&quot;</span><span class="p">)</span>

    <span class="c1"># === CONVERTING TO SPATIALPROTEOMICS ===</span>
    <span class="n">ds_imc</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">load_image_data</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channel_coords</span><span class="o">=</span><span class="n">markers</span><span class="p">,</span> <span class="n">segmentation</span><span class="o">=</span><span class="n">segmentation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds_imc</span>


<span class="n">ds_imc</span> <span class="o">=</span> <span class="n">read_imc_data</span><span class="p">(</span><span class="s2">&quot;../../data/raw-ablated-files/3964_DLBCL TMA #5_1_3964_1/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now that we have a dataset, we can look at the markers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_imc</span><span class="p">[</span><span class="s2">&quot;channels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;Histone3.Yb176Di&#39;, &#39;DNA.Ir193Di&#39;, &#39;CD45RA.Gd155Di&#39;,
       &#39;Vimentin.Nd143Di&#39;, &#39;Ki67.Er168Di&#39;, &#39;Membrane.In115Di&#39;,
       &#39;Tim3.Sm154Di&#39;, &#39;ICOS.Nd148Di&#39;, &#39;PD1.NAT105..Lu175Di&#39;,
       &#39;EphrinB2.Er166Di&#39;, &#39;CD20.Dy161Di&#39;, &#39;BCL2.Nd146Di&#39;, &#39;BCL6.Sm147Di&#39;,
       &#39;FOXP3.Dy163Di&#39;, &#39;Vista.Dy160Di&#39;, &#39;Lag3.Eu153Di&#39;, &#39;C.Myc.Dy164Di&#39;,
       &#39;CD3.Er170Di&#39;, &#39;p.Stat3.Gd158Di&#39;, &#39;CD134.Eu151Di&#39;, &#39;CCR4.Sm149Di&#39;,
       &#39;CD206.Tm169Di&#39;, &#39;DNA2.Ir191Di&#39;, &#39;CXCR3.Nd142Di&#39;, &#39;CD68.Tb159Di&#39;,
       &#39;Granzym.B.Er167Di&#39;, &#39;CD45RO.Yb173Di&#39;, &#39;CD8.Dy162Di&#39;,
       &#39;PDL1.Nd150Di&#39;, &#39;CD4.Gd156Di&#39;, &#39;CD30.Ho165Di&#39;, &#39;Tbet.Nd145Di&#39;,
       &#39;CD31.Nd144Di&#39;, &#39;HLADR.Yb174Di&#39;, &#39;PDL2.Yb172Di&#39;], dtype=&#39;&lt;U19&#39;)
</pre></div></div>
</div>
<p>We can now use these markers to predict cell types. This step involves thresholding the different channels. After thresholding, you should always ensure that your cell type labels look sensible.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marker_to_celltype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CD20.Dy161Di&quot;</span><span class="p">:</span> <span class="s2">&quot;B cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD3.Er170Di&quot;</span><span class="p">:</span> <span class="s2">&quot;T cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD31.Nd144Di&quot;</span><span class="p">:</span> <span class="s2">&quot;Endothelial cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD68.Tb159Di&quot;</span><span class="p">:</span> <span class="s2">&quot;Macrophage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Vimentin.Nd143Di&quot;</span><span class="p">:</span> <span class="s2">&quot;Stromal cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HLADR.Yb174Di&quot;</span><span class="p">:</span> <span class="s2">&quot;Dendritic cell&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">marker_to_color</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">marker_to_celltype</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">threshold_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CD20.Dy161Di&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s2">&quot;CD3.Er170Di&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s2">&quot;CD31.Nd144Di&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s2">&quot;CD68.Tb159Di&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s2">&quot;Vimentin.Nd143Di&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="s2">&quot;HLADR.Yb174Di&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ds_imc</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ds_imc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="n">threshold_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">channels</span><span class="o">=</span><span class="n">threshold_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">add_quantification</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="s2">&quot;intensity_mean&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">transform_expression_matrix</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;arcsinh&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">predict_cell_types_argmax</span><span class="p">(</span><span class="n">marker_to_celltype</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">set_label_colors</span><span class="p">(</span><span class="n">celltype_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Label Myeloid cell not found in the data object. Skipping.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_imc</span><span class="o">.</span><span class="n">pp</span><span class="p">[</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_imc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">render_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_MultiTechnologyIntegration_10_0.png" src="../_images/notebooks_MultiTechnologyIntegration_10_0.png" />
</div>
</div>
</section>
<section id="MACSima-imaging-cyclic-staining-(MICS)">
<h3>MACSima imaging cyclic staining (MICS)<a class="headerlink" href="#MACSima-imaging-cyclic-staining-(MICS)" title="Link to this heading">¶</a></h3>
<p>For MICS, we have a tonsil sample with high resolution. To illustrate how you can use <code class="docutils literal notranslate"><span class="pre">spatialproteomics</span></code> across different methods, we use <code class="docutils literal notranslate"><span class="pre">mesmer</span></code> to segment the cells based on DAPI and CD45.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">read_mics_data</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="c1"># === DATA READING ===</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7253</span><span class="p">,</span> <span class="mi">9182</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;*.tif&quot;</span><span class="p">):</span>
        <span class="n">marker_name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;ROI-21_A-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.tif&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">image_shape</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The image for marker </span><span class="si">{</span><span class="n">marker_name</span><span class="si">}</span><span class="s2"> had shape </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, expected </span><span class="si">{</span><span class="n">image_shape</span><span class="si">}</span><span class="s2">. Continuing...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">marker_name</span> <span class="ow">in</span> <span class="n">markers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already found marker </span><span class="si">{</span><span class="n">marker_name</span><span class="si">}</span><span class="s2">, continuing...&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker_name</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">images</span>

    <span class="c1"># === CONVERTING TO SPATIALPROTEOMICS ===</span>
    <span class="n">ds_mics</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">load_image_data</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">channel_coords</span><span class="o">=</span><span class="n">markers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds_mics</span>


<span class="n">ds_mics</span> <span class="o">=</span> <span class="n">read_mics_data</span><span class="p">(</span><span class="s2">&quot;../../data/Tonsil 2 - processed images/&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The image for marker AFP had shape (7060, 9184), expected (7253, 9182). Continuing...
Already found marker PE, continuing...
Already found marker FITC, continuing...
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># downsampling the image for faster runtime</span>
<span class="n">ds_mics</span> <span class="o">=</span> <span class="n">ds_mics</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">mesmer</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DAPI&quot;</span><span class="p">,</span> <span class="s2">&quot;CD45&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2025-09-09 14:22:48.686211: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libcudart.so.11.0&#39;; dlerror: libcudart.so.11.0: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /g/huber/users/meyerben/.conda/envs/tmp_env_3/lib/python3.10/site-packages/cv2/../../lib64:
2025-09-09 14:22:48.686243: I tensorflow/stream_executor/cuda/cudart_stub.cc:29] Ignore above cudart dlerror if you do not have a GPU set up on your machine.
</pre></div></div>
</div>
<p>Next, we can once again predict cell types. While our markers are different now, our celltypes are still the same. This means that we can still compare things such as cell type abundances and cell-cell interactions later, assuming our cell type predictions are sensible for all technologies.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marker_to_celltype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CD20&quot;</span><span class="p">:</span> <span class="s2">&quot;B cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD3&quot;</span><span class="p">:</span> <span class="s2">&quot;T cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD31&quot;</span><span class="p">:</span> <span class="s2">&quot;Endothelial cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD163&quot;</span><span class="p">:</span> <span class="s2">&quot;Macrophage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD1c_C-BDCA1&quot;</span><span class="p">:</span> <span class="s2">&quot;Dendritic cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD11b&quot;</span><span class="p">:</span> <span class="s2">&quot;Myeloid cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Vimentin&quot;</span><span class="p">:</span> <span class="s2">&quot;Stromal cell&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">marker_to_color</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">marker_to_celltype</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">threshold_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CD20&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s2">&quot;CD3&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="s2">&quot;CD31&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="s2">&quot;CD163&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="s2">&quot;CD1c_C-BDCA1&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
    <span class="s2">&quot;CD11b&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
    <span class="s2">&quot;Vimentin&quot;</span><span class="p">:</span> <span class="mf">0.98</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ds_mics</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ds_mics</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">quantile</span><span class="o">=</span><span class="n">threshold_dict</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">channels</span><span class="o">=</span><span class="n">threshold_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">add_quantification</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="s2">&quot;intensity_mean&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">transform_expression_matrix</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;arcsinh&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">predict_cell_types_argmax</span><span class="p">(</span><span class="n">marker_to_celltype</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">set_label_colors</span><span class="p">(</span><span class="n">celltype_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_mics</span><span class="o">.</span><span class="n">pp</span><span class="p">[</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_mics</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">render_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section id="CODEX">
<h1>CODEX<a class="headerlink" href="#CODEX" title="Link to this heading">¶</a></h1>
<p>This CODEX sample shows a DLBCL. It was segmented with <code class="docutils literal notranslate"><span class="pre">cellpose</span></code>, meaning that our three technologies were all segmented with different methods. In addition, it does not have the same markers as the other datasets, but the predicted cell types are the same.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marker_to_celltype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;PAX5&quot;</span><span class="p">:</span> <span class="s2">&quot;B cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD3&quot;</span><span class="p">:</span> <span class="s2">&quot;T cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD11b&quot;</span><span class="p">:</span> <span class="s2">&quot;Myeloid cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD68&quot;</span><span class="p">:</span> <span class="s2">&quot;Macrophage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD11c&quot;</span><span class="p">:</span> <span class="s2">&quot;Dendritic cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD90&quot;</span><span class="p">:</span> <span class="s2">&quot;Stromal cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Podoplanin&quot;</span><span class="p">:</span> <span class="s2">&quot;Stromal cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD31&quot;</span><span class="p">:</span> <span class="s2">&quot;Endothelial cell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD34&quot;</span><span class="p">:</span> <span class="s2">&quot;Endothelial cell&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">marker_to_color</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">marker_to_celltype</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">ds_codex</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="s2">&quot;../../data/DLBCL_21_1.zarr&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">set_label_level</span><span class="p">(</span><span class="s2">&quot;labels_0&quot;</span><span class="p">,</span> <span class="n">ignore_neighborhoods</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">la</span><span class="o">.</span><span class="n">set_label_colors</span><span class="p">(</span><span class="n">celltype_colors</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">celltype_colors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_codex</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">autocrop</span><span class="p">()</span><span class="o">.</span><span class="n">pp</span><span class="p">[</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">marker_to_color</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_codex</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">autocrop</span><span class="p">()</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">render_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Comparing-cell-type-abundances">
<h2>Comparing cell type abundances<a class="headerlink" href="#Comparing-cell-type-abundances" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get counts for each modality</span>
<span class="n">counts_imc</span> <span class="o">=</span> <span class="n">ds_imc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_layer_as_df</span><span class="p">()[</span><span class="s2">&quot;_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">counts_mics</span> <span class="o">=</span> <span class="n">ds_mics</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_layer_as_df</span><span class="p">()[</span><span class="s2">&quot;_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">counts_codex</span> <span class="o">=</span> <span class="n">ds_codex</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">get_layer_as_df</span><span class="p">()[</span><span class="s2">&quot;_labels&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Put into one dataframe</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;IMC (DLBCL)&quot;</span><span class="p">:</span> <span class="n">counts_imc</span><span class="p">,</span> <span class="s2">&quot;MICS (Tonsil)&quot;</span><span class="p">:</span> <span class="n">counts_mics</span><span class="p">,</span> <span class="s2">&quot;CODEX (DLBCL)&quot;</span><span class="p">:</span> <span class="n">counts_codex</span><span class="p">})</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Convert to relative abundances (fractions per modality)</span>
<span class="n">df_rel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Reshape into long format for seaborn</span>
<span class="n">df_rel</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df_rel</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="s2">&quot;_labels&quot;</span><span class="p">,</span>
        <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;IMC (DLBCL)&quot;</span><span class="p">,</span> <span class="s2">&quot;MICS (Tonsil)&quot;</span><span class="p">,</span> <span class="s2">&quot;CODEX (DLBCL)&quot;</span><span class="p">],</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;Modality&quot;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;Relative Abundance&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;_labels&quot;</span><span class="p">:</span> <span class="s2">&quot;CellType&quot;</span><span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_rel</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;CellType&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Relative Abundance&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Modality&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Cell Type&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="ArtifactRemoval.html" title="previous page">Interactive Removal of Artifacts</a>
    <a class='right-next' id="next-link" href="FAQ.html" title="next page">FAQ</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Matthias Meyer-Bender, Harald Vohringer<br/>
        
            &copy; Copyright 2024, Matthias Meyer-Bender, Harald Vohringer.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>