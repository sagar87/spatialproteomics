<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Interactive Removal of Artifacts &#8212; spatialproteomics</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css?v=a123c646" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script src="../_static/documentation_options.js?v=97fcea12"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js?v=dbd2e957"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting" href="Plotting.html" />
    <link rel="prev" title="Segmentation" href="Segmentation.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">spatialproteomics</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../preprocessing.html">
   The preprocessing (
   <code class="code docutils literal notranslate">
    <span class="pre">
     pp
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../label.html">
   The label (
   <code class="code docutils literal notranslate">
    <span class="pre">
     la
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../neighborhood.html">
   The neighborhood (
   <code class="code docutils literal notranslate">
    <span class="pre">
     nh
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../plot.html">
   The plot (
   <code class="code docutils literal notranslate">
    <span class="pre">
     pl
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tool.html">
   The tool (
   <code class="code docutils literal notranslate">
    <span class="pre">
     tl
    </span>
   </code>
   ) accessor
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../image_container.html">
   The image container
  </a>
 </li>
</ul>
<p class="caption collapsible-parent" role="heading">
 <span class="caption-text">
  Tutorials:
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="ExampleWorkflow.html">
   Example Workflow with spatialproteomics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Slicing.html">
   Subselecting Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Segmentation.html">
   Segmentation
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Interactive Removal of Artifacts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Plotting.html">
   Plotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ImageProcessing.html">
   Image Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="CellTypePrediction.html">
   Cell Type Prediction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Neighborhoods.html">
   Neighborhood Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Interoperability.html">
   Interoperability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Interactivity.html">
   Interactivity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="FAQ.html">
   FAQ
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/notebooks/ArtifactRemoval.ipynb.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Loading-the-image-from-a-zarr-file">
   Loading the image from a zarr file
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Drawing-in-the-healthy-regions-using-TissueTag">
   Drawing in the healthy regions using TissueTag
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Putting-the-mask-into-the-spatialproteomics-object">
   Putting the mask into the spatialproteomics object
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Using-the-mask-to-set-every-pixel-intensity-to-0-in-that-region">
   Using the mask to set every pixel intensity to 0 in that region
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#Using-the-mask-to-remove-cells-in-that-region">
   Using the mask to remove cells in that region
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Interactive-Removal-of-Artifacts">
<h1>Interactive Removal of Artifacts<a class="headerlink" href="#Interactive-Removal-of-Artifacts" title="Link to this heading">¶</a></h1>
<p>Sometimes, it can happen that only a part of the tissue is usable for analysis, for example due to artifacts or poor tissue quality in a certain region. In such cases, it can make sense to mask out problematic regions. This way, the image can still be used for downstream analysis, but the artifact will not influence results in a negative way. <code class="docutils literal notranslate"><span class="pre">Spatialproteomics</span></code> allows users to upload a binary mask, which indicates which part of the image is suitable for further analysis and which part is not.</p>
<p>The example below shows how one could for example use <a class="reference external" href="https://github.com/Teichlab/TissueTag/tree/main">TissueTag</a> to obtain such a mask, load it into the spatialproteomics and use the mask to remove the artifact. Note that TissueTag runs in jupyter notebooks or jupyter lab, but has no implementation for jupyterhub at the moment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">spatialproteomics</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
<section id="Loading-the-image-from-a-zarr-file">
<h2>Loading the image from a zarr file<a class="headerlink" href="#Loading-the-image-from-a-zarr-file" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;4_B4.zarr&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;zarr&#39;</span><span class="p">)</span>

<span class="c1"># quick plotting of some channels</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="p">[[</span><span class="s1">&#39;PAX5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span> <span class="s1">&#39;Podoplanin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">autocrop</span><span class="p">()</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/mbender/mambaforge/envs/interactive_cropping_env/lib/python3.10/site-packages/xarray/backends/plugins.py:159: RuntimeWarning: &#39;scipy&#39; fails while guessing
  warnings.warn(f&#34;{engine!r} fails while guessing&#34;, RuntimeWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div><svg style="position: absolute; width: 0; height: 0; overflow: hidden">
<defs>
<symbol id="icon-database" viewBox="0 0 32 32">
<path d="M16 0c-8.837 0-16 2.239-16 5v4c0 2.761 7.163 5 16 5s16-2.239 16-5v-4c0-2.761-7.163-5-16-5z"></path>
<path d="M16 17c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
<path d="M16 26c-8.837 0-16-2.239-16-5v6c0 2.761 7.163 5 16 5s16-2.239 16-5v-6c0 2.761-7.163 5-16 5z"></path>
</symbol>
<symbol id="icon-file-text2" viewBox="0 0 32 32">
<path d="M28.681 7.159c-0.694-0.947-1.662-2.053-2.724-3.116s-2.169-2.030-3.116-2.724c-1.612-1.182-2.393-1.319-2.841-1.319h-15.5c-1.378 0-2.5 1.121-2.5 2.5v27c0 1.378 1.122 2.5 2.5 2.5h23c1.378 0 2.5-1.122 2.5-2.5v-19.5c0-0.448-0.137-1.23-1.319-2.841zM24.543 5.457c0.959 0.959 1.712 1.825 2.268 2.543h-4.811v-4.811c0.718 0.556 1.584 1.309 2.543 2.268zM28 29.5c0 0.271-0.229 0.5-0.5 0.5h-23c-0.271 0-0.5-0.229-0.5-0.5v-27c0-0.271 0.229-0.5 0.5-0.5 0 0 15.499-0 15.5 0v7c0 0.552 0.448 1 1 1h7v19.5z"></path>
<path d="M23 26h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 22h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
<path d="M23 18h-14c-0.552 0-1-0.448-1-1s0.448-1 1-1h14c0.552 0 1 0.448 1 1s-0.448 1-1 1z"></path>
</symbol>
</defs>
</svg>
<style>/* CSS stylesheet for displaying xarray objects in jupyterlab.
 *
 */

:root {
  --xr-font-color0: var(--jp-content-font-color0, rgba(0, 0, 0, 1));
  --xr-font-color2: var(--jp-content-font-color2, rgba(0, 0, 0, 0.54));
  --xr-font-color3: var(--jp-content-font-color3, rgba(0, 0, 0, 0.38));
  --xr-border-color: var(--jp-border-color2, #e0e0e0);
  --xr-disabled-color: var(--jp-layout-color3, #bdbdbd);
  --xr-background-color: var(--jp-layout-color0, white);
  --xr-background-color-row-even: var(--jp-layout-color1, white);
  --xr-background-color-row-odd: var(--jp-layout-color2, #eeeeee);
}

html[theme=dark],
body[data-theme=dark],
body.vscode-dark {
  --xr-font-color0: rgba(255, 255, 255, 1);
  --xr-font-color2: rgba(255, 255, 255, 0.54);
  --xr-font-color3: rgba(255, 255, 255, 0.38);
  --xr-border-color: #1F1F1F;
  --xr-disabled-color: #515151;
  --xr-background-color: #111111;
  --xr-background-color-row-even: #111111;
  --xr-background-color-row-odd: #313131;
}

.xr-wrap {
  display: block !important;
  min-width: 300px;
  max-width: 700px;
}

.xr-text-repr-fallback {
  /* fallback to plain text repr when CSS is not injected (untrusted notebook) */
  display: none;
}

.xr-header {
  padding-top: 6px;
  padding-bottom: 6px;
  margin-bottom: 4px;
  border-bottom: solid 1px var(--xr-border-color);
}

.xr-header > div,
.xr-header > ul {
  display: inline;
  margin-top: 0;
  margin-bottom: 0;
}

.xr-obj-type,
.xr-array-name {
  margin-left: 2px;
  margin-right: 10px;
}

.xr-obj-type {
  color: var(--xr-font-color2);
}

.xr-sections {
  padding-left: 0 !important;
  display: grid;
  grid-template-columns: 150px auto auto 1fr 20px 20px;
}

.xr-section-item {
  display: contents;
}

.xr-section-item input {
  display: none;
}

.xr-section-item input + label {
  color: var(--xr-disabled-color);
}

.xr-section-item input:enabled + label {
  cursor: pointer;
  color: var(--xr-font-color2);
}

.xr-section-item input:enabled + label:hover {
  color: var(--xr-font-color0);
}

.xr-section-summary {
  grid-column: 1;
  color: var(--xr-font-color2);
  font-weight: 500;
}

.xr-section-summary > span {
  display: inline-block;
  padding-left: 0.5em;
}

.xr-section-summary-in:disabled + label {
  color: var(--xr-font-color2);
}

.xr-section-summary-in + label:before {
  display: inline-block;
  content: '►';
  font-size: 11px;
  width: 15px;
  text-align: center;
}

.xr-section-summary-in:disabled + label:before {
  color: var(--xr-disabled-color);
}

.xr-section-summary-in:checked + label:before {
  content: '▼';
}

.xr-section-summary-in:checked + label > span {
  display: none;
}

.xr-section-summary,
.xr-section-inline-details {
  padding-top: 4px;
  padding-bottom: 4px;
}

.xr-section-inline-details {
  grid-column: 2 / -1;
}

.xr-section-details {
  display: none;
  grid-column: 1 / -1;
  margin-bottom: 5px;
}

.xr-section-summary-in:checked ~ .xr-section-details {
  display: contents;
}

.xr-array-wrap {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: 20px auto;
}

.xr-array-wrap > label {
  grid-column: 1;
  vertical-align: top;
}

.xr-preview {
  color: var(--xr-font-color3);
}

.xr-array-preview,
.xr-array-data {
  padding: 0 5px !important;
  grid-column: 2;
}

.xr-array-data,
.xr-array-in:checked ~ .xr-array-preview {
  display: none;
}

.xr-array-in:checked ~ .xr-array-data,
.xr-array-preview {
  display: inline-block;
}

.xr-dim-list {
  display: inline-block !important;
  list-style: none;
  padding: 0 !important;
  margin: 0;
}

.xr-dim-list li {
  display: inline-block;
  padding: 0;
  margin: 0;
}

.xr-dim-list:before {
  content: '(';
}

.xr-dim-list:after {
  content: ')';
}

.xr-dim-list li:not(:last-child):after {
  content: ',';
  padding-right: 5px;
}

.xr-has-index {
  font-weight: bold;
}

.xr-var-list,
.xr-var-item {
  display: contents;
}

.xr-var-item > div,
.xr-var-item label,
.xr-var-item > .xr-var-name span {
  background-color: var(--xr-background-color-row-even);
  margin-bottom: 0;
}

.xr-var-item > .xr-var-name:hover span {
  padding-right: 5px;
}

.xr-var-list > li:nth-child(odd) > div,
.xr-var-list > li:nth-child(odd) > label,
.xr-var-list > li:nth-child(odd) > .xr-var-name span {
  background-color: var(--xr-background-color-row-odd);
}

.xr-var-name {
  grid-column: 1;
}

.xr-var-dims {
  grid-column: 2;
}

.xr-var-dtype {
  grid-column: 3;
  text-align: right;
  color: var(--xr-font-color2);
}

.xr-var-preview {
  grid-column: 4;
}

.xr-index-preview {
  grid-column: 2 / 5;
  color: var(--xr-font-color2);
}

.xr-var-name,
.xr-var-dims,
.xr-var-dtype,
.xr-preview,
.xr-attrs dt {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: 10px;
}

.xr-var-name:hover,
.xr-var-dims:hover,
.xr-var-dtype:hover,
.xr-attrs dt:hover {
  overflow: visible;
  width: auto;
  z-index: 1;
}

.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  display: none;
  background-color: var(--xr-background-color) !important;
  padding-bottom: 5px !important;
}

.xr-var-attrs-in:checked ~ .xr-var-attrs,
.xr-var-data-in:checked ~ .xr-var-data,
.xr-index-data-in:checked ~ .xr-index-data {
  display: block;
}

.xr-var-data > table {
  float: right;
}

.xr-var-name span,
.xr-var-data,
.xr-index-name div,
.xr-index-data,
.xr-attrs {
  padding-left: 25px !important;
}

.xr-attrs,
.xr-var-attrs,
.xr-var-data,
.xr-index-data {
  grid-column: 1 / -1;
}

dl.xr-attrs {
  padding: 0;
  margin: 0;
  display: grid;
  grid-template-columns: 125px auto;
}

.xr-attrs dt,
.xr-attrs dd {
  padding: 0;
  margin: 0;
  float: left;
  padding-right: 10px;
  width: auto;
}

.xr-attrs dt {
  font-weight: normal;
  grid-column: 1;
}

.xr-attrs dt:hover span {
  display: inline-block;
  background: var(--xr-background-color);
  padding-right: 10px;
}

.xr-attrs dd {
  grid-column: 2;
  white-space: pre-wrap;
  word-break: break-all;
}

.xr-icon-database,
.xr-icon-file-text2,
.xr-no-icon {
  display: inline-block;
  vertical-align: middle;
  width: 1em;
  height: 1.5em !important;
  stroke-width: 0;
  stroke: currentColor;
  fill: currentColor;
}
</style><pre class='xr-text-repr-fallback'>&lt;xarray.Dataset&gt;
Dimensions:                (cells: 8395, celltype_levels: 3, channels: 3,
                            y: 1811, x: 1721, features: 9, labels: 9, props: 2,
                            rgba: 4)
Coordinates:
  * cells                  (cells) int64 1 2 3 4 5 ... 8391 8392 8393 8394 8395
  * celltype_levels        (celltype_levels) &lt;U8 &#x27;labels&#x27; &#x27;labels_1&#x27; &#x27;labels_2&#x27;
  * channels               (channels) &lt;U11 &#x27;PAX5&#x27; &#x27;CD3&#x27; &#x27;Podoplanin&#x27;
  * features               (features) &lt;U10 &#x27;BCL-2&#x27; &#x27;CCR7&#x27; ... &#x27;ki-67&#x27;
  * labels                 (labels) int64 1 2 3 4 5 6 7 8 9
  * props                  (props) &lt;U6 &#x27;_color&#x27; &#x27;_name&#x27;
  * x                      (x) int64 70 71 72 73 74 ... 1786 1787 1788 1789 1790
  * y                      (y) int64 120 121 122 123 124 ... 1927 1928 1929 1930
  * rgba                   (rgba) &lt;U1 &#x27;r&#x27; &#x27;g&#x27; &#x27;b&#x27; &#x27;a&#x27;
Data variables:
    _celltype_predictions  (cells, celltype_levels) object &#x27;B&#x27; &#x27;B&#x27; ... &#x27;B&#x27; &#x27;B&#x27;
    _image                 (channels, y, x) uint8 1 1 0 1 0 0 0 ... 0 0 0 0 0 0
    _obs                   (cells, features) float64 1.0 0.0 0.0 ... 933.1 0.0
    _properties            (labels, props) object &#x27;#e6194B&#x27; &#x27;B&#x27; ... &#x27;T&#x27;
    _segmentation          (y, x) int64 0 0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0 0
    _plot                  (y, x, rgba) float64 0.02338 0.02922 ... 0.01153 1.0</pre><div class='xr-wrap' style='display:none'><div class='xr-header'><div class='xr-obj-type'>xarray.Dataset</div></div><ul class='xr-sections'><li class='xr-section-item'><input id='section-c3ec5a22-afb0-486c-b0a4-2647195e63df' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-c3ec5a22-afb0-486c-b0a4-2647195e63df' class='xr-section-summary'  title='Expand/collapse section'>Dimensions:</label><div class='xr-section-inline-details'><ul class='xr-dim-list'><li><span class='xr-has-index'>cells</span>: 8395</li><li><span class='xr-has-index'>celltype_levels</span>: 3</li><li><span class='xr-has-index'>channels</span>: 3</li><li><span class='xr-has-index'>y</span>: 1811</li><li><span class='xr-has-index'>x</span>: 1721</li><li><span class='xr-has-index'>features</span>: 9</li><li><span class='xr-has-index'>labels</span>: 9</li><li><span class='xr-has-index'>props</span>: 2</li><li><span class='xr-has-index'>rgba</span>: 4</li></ul></div><div class='xr-section-details'></div></li><li class='xr-section-item'><input id='section-6754b791-2e38-40a8-a43c-00f7d71b01c7' class='xr-section-summary-in' type='checkbox'  checked><label for='section-6754b791-2e38-40a8-a43c-00f7d71b01c7' class='xr-section-summary' >Coordinates: <span>(9)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>cells</span></div><div class='xr-var-dims'>(cells)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>1 2 3 4 5 ... 8392 8393 8394 8395</div><input id='attrs-90cab6f2-8df0-456b-929e-ea3445ca6742' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-90cab6f2-8df0-456b-929e-ea3445ca6742' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-dec657d1-5d75-48cd-b992-f2d1fee58830' class='xr-var-data-in' type='checkbox'><label for='data-dec657d1-5d75-48cd-b992-f2d1fee58830' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([   1,    2,    3, ..., 8393, 8394, 8395])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>celltype_levels</span></div><div class='xr-var-dims'>(celltype_levels)</div><div class='xr-var-dtype'>&lt;U8</div><div class='xr-var-preview xr-preview'>&#x27;labels&#x27; &#x27;labels_1&#x27; &#x27;labels_2&#x27;</div><input id='attrs-8e48d19d-1556-4e92-be45-5bf235311205' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-8e48d19d-1556-4e92-be45-5bf235311205' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-062f6819-c191-4d8f-aa36-bb1de189dbf5' class='xr-var-data-in' type='checkbox'><label for='data-062f6819-c191-4d8f-aa36-bb1de189dbf5' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;labels&#x27;, &#x27;labels_1&#x27;, &#x27;labels_2&#x27;], dtype=&#x27;&lt;U8&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>channels</span></div><div class='xr-var-dims'>(channels)</div><div class='xr-var-dtype'>&lt;U11</div><div class='xr-var-preview xr-preview'>&#x27;PAX5&#x27; &#x27;CD3&#x27; &#x27;Podoplanin&#x27;</div><input id='attrs-19b4b25b-23fa-4419-8e0f-e97609f02a3b' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-19b4b25b-23fa-4419-8e0f-e97609f02a3b' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-b312b456-f1d5-44ee-8ad9-84428392f600' class='xr-var-data-in' type='checkbox'><label for='data-b312b456-f1d5-44ee-8ad9-84428392f600' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;PAX5&#x27;, &#x27;CD3&#x27;, &#x27;Podoplanin&#x27;], dtype=&#x27;&lt;U11&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>features</span></div><div class='xr-var-dims'>(features)</div><div class='xr-var-dtype'>&lt;U10</div><div class='xr-var-preview xr-preview'>&#x27;BCL-2&#x27; &#x27;CCR7&#x27; ... &#x27;ki-67&#x27;</div><input id='attrs-1adb024b-fb7b-4f30-a17b-1e78170b5af1' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-1adb024b-fb7b-4f30-a17b-1e78170b5af1' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-15545e06-de4e-42df-9053-eacb76d9d0c7' class='xr-var-data-in' type='checkbox'><label for='data-15545e06-de4e-42df-9053-eacb76d9d0c7' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;BCL-2&#x27;, &#x27;CCR7&#x27;, &#x27;CD8&#x27;, &#x27;LAG3&#x27;, &#x27;TIM3&#x27;, &#x27;_labels&#x27;, &#x27;centroid-0&#x27;,
       &#x27;centroid-1&#x27;, &#x27;ki-67&#x27;], dtype=&#x27;&lt;U10&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>labels</span></div><div class='xr-var-dims'>(labels)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>1 2 3 4 5 6 7 8 9</div><input id='attrs-aceb4a4d-81d1-4c28-96dd-291d47acd00c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-aceb4a4d-81d1-4c28-96dd-291d47acd00c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-aa7ab79e-10e1-45b7-85c5-18180e3a1011' class='xr-var-data-in' type='checkbox'><label for='data-aa7ab79e-10e1-45b7-85c5-18180e3a1011' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([1, 2, 3, 4, 5, 6, 7, 8, 9])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>props</span></div><div class='xr-var-dims'>(props)</div><div class='xr-var-dtype'>&lt;U6</div><div class='xr-var-preview xr-preview'>&#x27;_color&#x27; &#x27;_name&#x27;</div><input id='attrs-71f88927-977f-4deb-b965-211acd31112f' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-71f88927-977f-4deb-b965-211acd31112f' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7216fd0c-e8dc-43e7-b120-6db13c568d22' class='xr-var-data-in' type='checkbox'><label for='data-7216fd0c-e8dc-43e7-b120-6db13c568d22' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;_color&#x27;, &#x27;_name&#x27;], dtype=&#x27;&lt;U6&#x27;)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>x</span></div><div class='xr-var-dims'>(x)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>70 71 72 73 ... 1787 1788 1789 1790</div><input id='attrs-cd52287a-b20b-4fe4-9e00-9ca2be9151a6' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-cd52287a-b20b-4fe4-9e00-9ca2be9151a6' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-75995470-45bb-4989-97f3-bc0289d0108c' class='xr-var-data-in' type='checkbox'><label for='data-75995470-45bb-4989-97f3-bc0289d0108c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([  70,   71,   72, ..., 1788, 1789, 1790])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>y</span></div><div class='xr-var-dims'>(y)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>120 121 122 123 ... 1928 1929 1930</div><input id='attrs-e0e7aea6-1abc-4cd9-8781-6a08bf6e8378' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-e0e7aea6-1abc-4cd9-8781-6a08bf6e8378' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-7680bdb1-f7b9-4f00-9d09-15e52f24e2fe' class='xr-var-data-in' type='checkbox'><label for='data-7680bdb1-f7b9-4f00-9d09-15e52f24e2fe' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([ 120,  121,  122, ..., 1928, 1929, 1930])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span class='xr-has-index'>rgba</span></div><div class='xr-var-dims'>(rgba)</div><div class='xr-var-dtype'>&lt;U1</div><div class='xr-var-preview xr-preview'>&#x27;r&#x27; &#x27;g&#x27; &#x27;b&#x27; &#x27;a&#x27;</div><input id='attrs-d6e86930-5858-4cc2-9f5a-2925dbc429b6' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-d6e86930-5858-4cc2-9f5a-2925dbc429b6' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-01313030-9c9f-494a-b817-b38f75681139' class='xr-var-data-in' type='checkbox'><label for='data-01313030-9c9f-494a-b817-b38f75681139' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([&#x27;r&#x27;, &#x27;g&#x27;, &#x27;b&#x27;, &#x27;a&#x27;], dtype=&#x27;&lt;U1&#x27;)</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-d8183b2f-722a-45f3-adf2-232fb3a08021' class='xr-section-summary-in' type='checkbox'  checked><label for='section-d8183b2f-722a-45f3-adf2-232fb3a08021' class='xr-section-summary' >Data variables: <span>(6)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-var-name'><span>_celltype_predictions</span></div><div class='xr-var-dims'>(cells, celltype_levels)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;B&#x27; &#x27;B&#x27; &#x27;B&#x27; &#x27;B&#x27; ... &#x27;B&#x27; &#x27;B&#x27; &#x27;B&#x27; &#x27;B&#x27;</div><input id='attrs-7783818e-5a09-47b6-b7b4-b4329e60a8c7' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-7783818e-5a09-47b6-b7b4-b4329e60a8c7' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-d1fbbd53-a6b0-4626-b028-582657865388' class='xr-var-data-in' type='checkbox'><label for='data-d1fbbd53-a6b0-4626-b028-582657865388' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;],
       [&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;],
       [&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;],
       ...,
       [&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;],
       [&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;],
       [&#x27;B&#x27;, &#x27;B&#x27;, &#x27;B&#x27;]], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>_image</span></div><div class='xr-var-dims'>(channels, y, x)</div><div class='xr-var-dtype'>uint8</div><div class='xr-var-preview xr-preview'>1 1 0 1 0 0 0 0 ... 0 0 0 0 0 0 0 0</div><input id='attrs-c27edfb4-f2dc-4aa0-800e-de188eb051d2' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-c27edfb4-f2dc-4aa0-800e-de188eb051d2' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-29bdd0a9-b296-4d38-8045-e704ba257371' class='xr-var-data-in' type='checkbox'><label for='data-29bdd0a9-b296-4d38-8045-e704ba257371' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[[1, 1, 0, ..., 1, 0, 0],
        [1, 0, 0, ..., 1, 0, 1],
        [1, 0, 0, ..., 0, 1, 0],
        ...,
        [0, 0, 0, ..., 0, 1, 1],
        [1, 0, 0, ..., 1, 0, 1],
        [1, 1, 0, ..., 1, 0, 0]],

       [[1, 1, 0, ..., 0, 1, 0],
        [1, 0, 0, ..., 1, 1, 0],
        [1, 0, 1, ..., 1, 0, 0],
        ...,
        [0, 1, 1, ..., 2, 0, 0],
        [0, 1, 0, ..., 1, 1, 1],
        [1, 0, 1, ..., 0, 0, 1]],

       [[0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        ...,
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0],
        [0, 0, 0, ..., 0, 0, 0]]], dtype=uint8)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>_obs</span></div><div class='xr-var-dims'>(cells, features)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>1.0 0.0 0.0 ... 1.872e+03 933.1 0.0</div><input id='attrs-3084b80f-f779-4ff1-a252-86199c72de49' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-3084b80f-f779-4ff1-a252-86199c72de49' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-42916693-8a7d-4489-a760-6514d4e69f5c' class='xr-var-data-in' type='checkbox'><label for='data-42916693-8a7d-4489-a760-6514d4e69f5c' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.64159722e+02, 9.96729167e+02, 0.00000000e+00],
       [1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.69883041e+02, 9.29573099e+02, 0.00000000e+00],
       [1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.69355769e+02, 1.01019231e+03, 0.00000000e+00],
       ...,
       [1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.87248333e+03, 9.13303333e+02, 0.00000000e+00],
       [1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.87208046e+03, 8.79931034e+02, 0.00000000e+00],
       [1.00000000e+00, 0.00000000e+00, 0.00000000e+00, ...,
        1.87214516e+03, 9.33123656e+02, 0.00000000e+00]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>_properties</span></div><div class='xr-var-dims'>(labels, props)</div><div class='xr-var-dtype'>object</div><div class='xr-var-preview xr-preview'>&#x27;#e6194B&#x27; &#x27;B&#x27; ... &#x27;#3cb44b&#x27; &#x27;T&#x27;</div><input id='attrs-53d8954f-7b1c-480d-827e-856b8abdd498' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-53d8954f-7b1c-480d-827e-856b8abdd498' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-c08908ab-c0cb-4eab-9f22-8884e5b62245' class='xr-var-data-in' type='checkbox'><label for='data-c08908ab-c0cb-4eab-9f22-8884e5b62245' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[&#x27;#e6194B&#x27;, &#x27;B&#x27;],
       [&#x27;#4363d8&#x27;, &#x27;Dendritic&#x27;],
       [&#x27;#911eb4&#x27;, &#x27;Macro&#x27;],
       [&#x27;#ffe119&#x27;, &#x27;Myeloid&#x27;],
       [&#x27;#bfef45&#x27;, &#x27;Stroma CD31&#x27;],
       [&#x27;#42d4f4&#x27;, &#x27;Stroma CD34&#x27;],
       [&#x27;#f032e6&#x27;, &#x27;Stroma CD90&#x27;],
       [&#x27;#f58231&#x27;, &#x27;Stroma PDPN&#x27;],
       [&#x27;#3cb44b&#x27;, &#x27;T&#x27;]], dtype=object)</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>_segmentation</span></div><div class='xr-var-dims'>(y, x)</div><div class='xr-var-dtype'>int64</div><div class='xr-var-preview xr-preview'>0 0 0 0 0 0 0 0 ... 0 0 0 0 0 0 0 0</div><input id='attrs-55bf310c-62bd-431d-aa9a-68593db1442c' class='xr-var-attrs-in' type='checkbox' disabled><label for='attrs-55bf310c-62bd-431d-aa9a-68593db1442c' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-20bae29f-2261-4c78-a0bd-19ba7b36e022' class='xr-var-data-in' type='checkbox'><label for='data-20bae29f-2261-4c78-a0bd-19ba7b36e022' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'></dl></div><div class='xr-var-data'><pre>array([[0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       ...,
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0],
       [0, 0, 0, ..., 0, 0, 0]])</pre></div></li><li class='xr-var-item'><div class='xr-var-name'><span>_plot</span></div><div class='xr-var-dims'>(y, x, rgba)</div><div class='xr-var-dtype'>float64</div><div class='xr-var-preview xr-preview'>0.02338 0.02922 ... 0.01153 1.0</div><input id='attrs-91cf4a89-b1e1-41e8-9812-8c0449adcec3' class='xr-var-attrs-in' type='checkbox' ><label for='attrs-91cf4a89-b1e1-41e8-9812-8c0449adcec3' title='Show/Hide attributes'><svg class='icon xr-icon-file-text2'><use xlink:href='#icon-file-text2'></use></svg></label><input id='data-ed52c553-822f-4451-b734-0507d51546dd' class='xr-var-data-in' type='checkbox'><label for='data-ed52c553-822f-4451-b734-0507d51546dd' title='Show/Hide data repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-var-attrs'><dl class='xr-attrs'><dt><span>image_colors :</span></dt><dd>{&#x27;PAX5&#x27;: &#x27;#e6194B&#x27;, &#x27;CD3&#x27;: &#x27;#3cb44b&#x27;, &#x27;Podoplanin&#x27;: &#x27;#ffe119&#x27;}</dd></dl></div><div class='xr-var-data'><pre>array([[[0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        ...,
        [0.0141484 , 0.00153787, 0.00461361, 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        [0.        , 0.        , 0.        , 1.        ]],

       [[0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        ...,
        [0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        [0.0141484 , 0.00153787, 0.00461361, 1.        ]],

       [[0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        ...,
...
        ...,
        [0.01937716, 0.05813149, 0.02422145, 1.        ],
        [0.0141484 , 0.00153787, 0.00461361, 1.        ],
        [0.0141484 , 0.00153787, 0.00461361, 1.        ]],

       [[0.0141484 , 0.00153787, 0.00461361, 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        ...,
        [0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        [0.02337562, 0.02921953, 0.01614764, 1.        ]],

       [[0.02337562, 0.02921953, 0.01614764, 1.        ],
        [0.0141484 , 0.00153787, 0.00461361, 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ],
        ...,
        [0.0141484 , 0.00153787, 0.00461361, 1.        ],
        [0.        , 0.        , 0.        , 1.        ],
        [0.00922722, 0.02768166, 0.01153403, 1.        ]]])</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-8c9f662f-44eb-4f24-b1dd-138e0420f6cf' class='xr-section-summary-in' type='checkbox'  ><label for='section-8c9f662f-44eb-4f24-b1dd-138e0420f6cf' class='xr-section-summary' >Indexes: <span>(9)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><ul class='xr-var-list'><li class='xr-var-item'><div class='xr-index-name'><div>cells</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-cb886003-156a-43a9-865a-d6bf2b0d5532' class='xr-index-data-in' type='checkbox'/><label for='index-cb886003-156a-43a9-865a-d6bf2b0d5532' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([   1,    2,    3,    4,    5,    6,    7,    8,    9,   10,
       ...
       8386, 8387, 8388, 8389, 8390, 8391, 8392, 8393, 8394, 8395],
      dtype=&#x27;int64&#x27;, name=&#x27;cells&#x27;, length=8395))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>celltype_levels</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-d6482913-d9f5-42d4-9482-9444e50dc748' class='xr-index-data-in' type='checkbox'/><label for='index-d6482913-d9f5-42d4-9482-9444e50dc748' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;labels&#x27;, &#x27;labels_1&#x27;, &#x27;labels_2&#x27;], dtype=&#x27;object&#x27;, name=&#x27;celltype_levels&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>channels</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-53f0421f-e4ea-43b2-901b-6c6d6816471e' class='xr-index-data-in' type='checkbox'/><label for='index-53f0421f-e4ea-43b2-901b-6c6d6816471e' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;PAX5&#x27;, &#x27;CD3&#x27;, &#x27;Podoplanin&#x27;], dtype=&#x27;object&#x27;, name=&#x27;channels&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>features</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-71df0f5f-6b29-43f1-955d-8230966f6342' class='xr-index-data-in' type='checkbox'/><label for='index-71df0f5f-6b29-43f1-955d-8230966f6342' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;BCL-2&#x27;, &#x27;CCR7&#x27;, &#x27;CD8&#x27;, &#x27;LAG3&#x27;, &#x27;TIM3&#x27;, &#x27;_labels&#x27;, &#x27;centroid-0&#x27;,
       &#x27;centroid-1&#x27;, &#x27;ki-67&#x27;],
      dtype=&#x27;object&#x27;, name=&#x27;features&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>labels</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-ccb9de08-0afe-460a-b015-8268f6ee7213' class='xr-index-data-in' type='checkbox'/><label for='index-ccb9de08-0afe-460a-b015-8268f6ee7213' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([1, 2, 3, 4, 5, 6, 7, 8, 9], dtype=&#x27;int64&#x27;, name=&#x27;labels&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>props</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-ae63e9ad-ee99-4572-9072-88ccd6a515bd' class='xr-index-data-in' type='checkbox'/><label for='index-ae63e9ad-ee99-4572-9072-88ccd6a515bd' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;_color&#x27;, &#x27;_name&#x27;], dtype=&#x27;object&#x27;, name=&#x27;props&#x27;))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>x</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-0ab8c674-59ac-4217-97c4-ad5e3bdea204' class='xr-index-data-in' type='checkbox'/><label for='index-0ab8c674-59ac-4217-97c4-ad5e3bdea204' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([  70,   71,   72,   73,   74,   75,   76,   77,   78,   79,
       ...
       1781, 1782, 1783, 1784, 1785, 1786, 1787, 1788, 1789, 1790],
      dtype=&#x27;int64&#x27;, name=&#x27;x&#x27;, length=1721))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>y</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-f9439130-a451-4d2d-a4d3-a487aebf2382' class='xr-index-data-in' type='checkbox'/><label for='index-f9439130-a451-4d2d-a4d3-a487aebf2382' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([ 120,  121,  122,  123,  124,  125,  126,  127,  128,  129,
       ...
       1921, 1922, 1923, 1924, 1925, 1926, 1927, 1928, 1929, 1930],
      dtype=&#x27;int64&#x27;, name=&#x27;y&#x27;, length=1811))</pre></div></li><li class='xr-var-item'><div class='xr-index-name'><div>rgba</div></div><div class='xr-index-preview'>PandasIndex</div><div></div><input id='index-0a8036db-ad2f-4005-93f9-2be53195dcfc' class='xr-index-data-in' type='checkbox'/><label for='index-0a8036db-ad2f-4005-93f9-2be53195dcfc' title='Show/Hide index repr'><svg class='icon xr-icon-database'><use xlink:href='#icon-database'></use></svg></label><div class='xr-index-data'><pre>PandasIndex(Index([&#x27;r&#x27;, &#x27;g&#x27;, &#x27;b&#x27;, &#x27;a&#x27;], dtype=&#x27;object&#x27;, name=&#x27;rgba&#x27;))</pre></div></li></ul></div></li><li class='xr-section-item'><input id='section-f43bcc14-c3a3-49ef-a023-4608587eb927' class='xr-section-summary-in' type='checkbox' disabled ><label for='section-f43bcc14-c3a3-49ef-a023-4608587eb927' class='xr-section-summary'  title='Expand/collapse section'>Attributes: <span>(0)</span></label><div class='xr-section-inline-details'></div><div class='xr-section-details'><dl class='xr-attrs'></dl></div></li></ul></div></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_3_2.png" src="../_images/notebooks_ArtifactRemoval_3_2.png" />
</div>
</div>
</section>
<section id="Drawing-in-the-healthy-regions-using-TissueTag">
<h2>Drawing in the healthy regions using TissueTag<a class="headerlink" href="#Drawing-in-the-healthy-regions-using-TissueTag" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># first, we need to get our image as an RGBA image</span>

<span class="c1"># here, we extract the Podoplanin channel and assign it to the red and green channel, while keeping the blue channel at 0 and setting alpha to 1 everywhere</span>
<span class="n">podoplanin_img</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="p">[</span><span class="s1">&#39;Podoplanin&#39;</span><span class="p">][</span><span class="s1">&#39;_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Create the RGBA image by stacking channels (R, G, B, A)</span>
<span class="n">rgba_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">podoplanin_img</span><span class="p">,</span> <span class="n">podoplanin_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">podoplanin_img</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">podoplanin_img</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x16a049390&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_5_1.png" src="../_images/notebooks_ArtifactRemoval_5_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># next, we set up the annotation layer, which will ultimately become the binary mask that tells us where the tissue is</span>
<span class="n">annodict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Artifact&#39;</span><span class="p">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">}</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rgba_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rgba_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup for TissueTag</span>
<span class="kn">import</span> <span class="nn">panel</span> <span class="k">as</span> <span class="nn">pn</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tissue_tag</span> <span class="k">as</span> <span class="nn">tt</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;BOKEH_ALLOW_WS_ORIGIN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
<span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;8888&#39;</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use annotator to label tissue regions according to categories indicated above</span>
<span class="n">annotator</span><span class="p">,</span> <span class="n">render_dict</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">annotator</span><span class="p">(</span><span class="n">rgba_image</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">anno_dict</span><span class="o">=</span><span class="n">annodict</span><span class="p">,</span> <span class="n">use_datashader</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pn</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">notebook</span><span class="o">.</span><span class="n">show_server</span><span class="p">(</span><span class="n">annotator</span><span class="p">,</span> <span class="n">notebook_url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Starting Bokeh server version 3.4.3 (running on Tornado 6.4.1)
User authentication hooks NOT provided (default user enabled)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<script id="f1ca8cc2-1758-4c3d-a83c-757b15543c0d">
  (function() {
    const xhr = new XMLHttpRequest()
    xhr.responseType = 'blob';
    xhr.open('GET', "http://mac-huber33.local:53395/autoload.js?bokeh-autoload-element=f1ca8cc2-1758-4c3d-a83c-757b15543c0d&bokeh-absolute-url=http://mac-huber33.local:53395&resources=none", true);
    xhr.onload = function (event) {
      const script = document.createElement('script');
      const src = URL.createObjectURL(event.target.response);
      script.src = src;
      document.body.appendChild(script);
    };
    xhr.send();
  })();
</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;panel.io.server.Server at 0x16a01c0a0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
200 GET /autoload.js?bokeh-autoload-element=f1ca8cc2-1758-4c3d-a83c-757b15543c0d&amp;bokeh-absolute-url=http://mac-huber33.local:53395&amp;resources=none (::1) 189.82ms
INFO:tornado.access:200 GET /autoload.js?bokeh-autoload-element=f1ca8cc2-1758-4c3d-a83c-757b15543c0d&amp;bokeh-absolute-url=http://mac-huber33.local:53395&amp;resources=none (::1) 189.82ms
200 GET /static/js/bokeh.min.js?v=0a5da0be1c2385c8fbc778b6fe92af35da98e7b160ed40850e1b234b02df34a055ca50d37f82f056d346f1a6812c836eecbfb99371cfc264da60861011003592 (::1) 3.30ms
INFO:tornado.access:200 GET /static/js/bokeh.min.js?v=0a5da0be1c2385c8fbc778b6fe92af35da98e7b160ed40850e1b234b02df34a055ca50d37f82f056d346f1a6812c836eecbfb99371cfc264da60861011003592 (::1) 3.30ms
200 GET /static/js/bokeh-tables.min.js?v=30dd48a6c21439042b22c0586013c023610fdaba3c28ecd2549991ee689caaf69984c17f610f0259a9e7b9a0cec40dd018f52d36b47a6bd65e10d9885d3a861e (::1) 1.60ms
INFO:tornado.access:200 GET /static/js/bokeh-tables.min.js?v=30dd48a6c21439042b22c0586013c023610fdaba3c28ecd2549991ee689caaf69984c17f610f0259a9e7b9a0cec40dd018f52d36b47a6bd65e10d9885d3a861e (::1) 1.60ms
200 GET /static/extensions/panel/panel.min.js?v=6c2906ba8ee98ee2fe96712bd552abc490c7d847b686180f7d054bab534e4685 (::1) 2.84ms
INFO:tornado.access:200 GET /static/extensions/panel/panel.min.js?v=6c2906ba8ee98ee2fe96712bd552abc490c7d847b686180f7d054bab534e4685 (::1) 2.84ms
200 GET /static/js/bokeh-gl.min.js?v=2bba96f5a73c631f21cb84fc6eb04f860e9b43e809ffaf3e7c7a60109b6c6c42a9b83a3d4bdadb0cb023bd48069e8d5cb2ee624da5fa4d5839469ac6818a41af (::1) 4.07ms
INFO:tornado.access:200 GET /static/js/bokeh-gl.min.js?v=2bba96f5a73c631f21cb84fc6eb04f860e9b43e809ffaf3e7c7a60109b6c6c42a9b83a3d4bdadb0cb023bd48069e8d5cb2ee624da5fa4d5839469ac6818a41af (::1) 4.07ms
200 GET /static/js/bokeh-widgets.min.js?v=bf4eea8535eba9536cc13c5656d74f40bbf1448e73e48ddf7eaddff850f7d0093bc141ef1da5e7579585c338db8db7bb4b306cbcde009d4dbe9af2e7c2d609fb (::1) 5.25ms
INFO:tornado.access:200 GET /static/js/bokeh-widgets.min.js?v=bf4eea8535eba9536cc13c5656d74f40bbf1448e73e48ddf7eaddff850f7d0093bc141ef1da5e7579585c338db8db7bb4b306cbcde009d4dbe9af2e7c2d609fb (::1) 5.25ms
101 GET /ws (::1) 0.31ms
INFO:tornado.access:101 GET /ws (::1) 0.31ms
WebSocket connection opened
ServerConnection created
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">update_annotator</span><span class="p">(</span>
    <span class="n">imarray</span><span class="o">=</span><span class="n">rgba_image</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
    <span class="n">anno_dict</span><span class="o">=</span><span class="n">annodict</span><span class="p">,</span>
    <span class="n">render_dict</span><span class="o">=</span><span class="n">render_dict</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Artifact
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_9_1.png" src="../_images/notebooks_ArtifactRemoval_9_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inverting the labels so that 0 becomes 1 and 1 becomes 0</span>
<span class="c1"># the region where the artifact is should be 0, everything else should be 1</span>
<span class="n">labels</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
</section>
<section id="Putting-the-mask-into-the-spatialproteomics-object">
<h2>Putting the mask into the spatialproteomics object<a class="headerlink" href="#Putting-the-mask-into-the-spatialproteomics-object" title="Link to this heading">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># by default, this method adds a layer with the key &#39;_mask&#39;</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting the mask (by using the render_segmentation method, since the data structure is conceptually similar to the segmentation)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">render_segmentation</span><span class="p">(</span><span class="n">layer_key</span><span class="o">=</span><span class="s1">&#39;_mask&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">imshow</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_13_0.png" src="../_images/notebooks_ArtifactRemoval_13_0.png" />
</div>
</div>
</section>
<section id="Using-the-mask-to-set-every-pixel-intensity-to-0-in-that-region">
<h2>Using the mask to set every pixel intensity to 0 in that region<a class="headerlink" href="#Using-the-mask-to-set-every-pixel-intensity-to-0-in-that-region" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_masked_intensities</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">mask_region</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_masked_intensities</span><span class="o">.</span><span class="n">pp</span><span class="p">[[</span><span class="s1">&#39;PAX5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span> <span class="s1">&#39;Podoplanin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_15_0.png" src="../_images/notebooks_ArtifactRemoval_15_0.png" />
</div>
</div>
<p>You can see that this set all of the marker intensities at 0 in the problematic region. However, if we plot the segmentation masks on top, you can see that we have not removed those.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ds_masked_intensities</span><span class="o">.</span><span class="n">pp</span><span class="p">[[</span><span class="s1">&#39;PAX5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span> <span class="s1">&#39;Podoplanin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_17_0.png" src="../_images/notebooks_ArtifactRemoval_17_0.png" />
</div>
</div>
<p>Most of the time, what we want to do instead is to remove all cells that were segmented in the area. This way we still stick to the original data, but remove the problematic region from analysis.</p>
</section>
<section id="Using-the-mask-to-remove-cells-in-that-region">
<h2>Using the mask to remove cells in that region<a class="headerlink" href="#Using-the-mask-to-remove-cells-in-that-region" title="Link to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds_masked_cells</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">mask_cells</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ds_masked_cells</span><span class="o">.</span><span class="n">pp</span><span class="p">[[</span><span class="s1">&#39;PAX5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span> <span class="s1">&#39;Podoplanin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_20_0.png" src="../_images/notebooks_ArtifactRemoval_20_0.png" />
</div>
</div>
<p>You can of course also combine the two.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">mask_region</span><span class="p">()</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">mask_cells</span><span class="p">()</span><span class="o">.</span><span class="n">pp</span><span class="p">[[</span><span class="s1">&#39;PAX5&#39;</span><span class="p">,</span> <span class="s1">&#39;CD3&#39;</span><span class="p">,</span> <span class="s1">&#39;Podoplanin&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">render_segmentation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_ArtifactRemoval_22_0.png" src="../_images/notebooks_ArtifactRemoval_22_0.png" />
</div>
</div>
</section>
</section>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Segmentation.html" title="previous page">Segmentation</a>
    <a class='right-next' id="next-link" href="Plotting.html" title="next page">Plotting</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Matthias Meyer-Bender, Harald Vohringer<br/>
        
            &copy; Copyright 2024, Matthias Meyer-Bender, Harald Vohringer.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>